---
import BaseLayout from '../layouts/BaseLayout.astro';
import Container from '../components/ui/Container.astro';
import Card from '../components/ui/Card.astro';
import { fetchGraphQL, isWordPressAvailable } from '../lib/wordpress';

// Test query - get general info
const TEST_QUERY = `
  query TestQuery {
    generalSettings {
      title
      description
      url
    }
    projects(first: 5) {
      nodes {
        id
        title
        slug
      }
    }
    posts(first: 5) {
      nodes {
        id
        title
        slug
      }
    }
  }
`;

let wpAvailable = false;
let data: any = null;
let error: string | null = null;

try {
  wpAvailable = await isWordPressAvailable();
  if (wpAvailable) {
    data = await fetchGraphQL(TEST_QUERY);
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'Erreur inconnue';
}
---

<BaseLayout
  title="Test GraphQL"
  description="Page de test de la connexion WordPress GraphQL"
>
  <section class="py-32">
    <Container>
      <h1 class="text-4xl font-bold mb-8">Test GraphQL</h1>

      <!-- Status -->
      <Card class="mb-8">
        <h2 class="text-xl font-semibold mb-4">Statut de connexion</h2>
        <div class="flex items-center gap-3">
          <div class={`w-4 h-4 rounded-full ${wpAvailable ? 'bg-success' : 'bg-error'}`}></div>
          <span class={wpAvailable ? 'text-success' : 'text-error'}>
            {wpAvailable ? 'WordPress GraphQL connecté' : 'WordPress non disponible'}
          </span>
        </div>
        <p class="text-text-muted mt-2 text-sm">
          URL: {import.meta.env.WP_GRAPHQL_URL || 'http://localhost/local.rework.com/graphql'}
        </p>
      </Card>

      {error && (
        <Card class="mb-8 border-error/50">
          <h2 class="text-xl font-semibold mb-4 text-error">Erreur</h2>
          <pre class="text-sm text-error bg-error/10 p-4 rounded-lg overflow-auto">{error}</pre>
        </Card>
      )}

      {data && (
        <>
          <!-- General Settings -->
          <Card class="mb-8">
            <h2 class="text-xl font-semibold mb-4">Paramètres WordPress</h2>
            <dl class="space-y-2">
              <div class="flex gap-2">
                <dt class="text-text-muted">Titre:</dt>
                <dd>{data.generalSettings?.title || 'Non défini'}</dd>
              </div>
              <div class="flex gap-2">
                <dt class="text-text-muted">Description:</dt>
                <dd>{data.generalSettings?.description || 'Non défini'}</dd>
              </div>
              <div class="flex gap-2">
                <dt class="text-text-muted">URL:</dt>
                <dd>{data.generalSettings?.url || 'Non défini'}</dd>
              </div>
            </dl>
          </Card>

          <!-- Projects -->
          <Card class="mb-8">
            <h2 class="text-xl font-semibold mb-4">
              Projets ({data.projects?.nodes?.length || 0})
            </h2>
            {data.projects?.nodes?.length > 0 ? (
              <ul class="space-y-2">
                {data.projects.nodes.map((project: any) => (
                  <li class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-accent-primary"></span>
                    <span>{project.title}</span>
                    <span class="text-text-muted text-sm">/{project.slug}</span>
                  </li>
                ))}
              </ul>
            ) : (
              <p class="text-text-muted">Aucun projet trouvé. Créez-en dans WordPress Admin.</p>
            )}
          </Card>

          <!-- Posts -->
          <Card class="mb-8">
            <h2 class="text-xl font-semibold mb-4">
              Articles ({data.posts?.nodes?.length || 0})
            </h2>
            {data.posts?.nodes?.length > 0 ? (
              <ul class="space-y-2">
                {data.posts.nodes.map((post: any) => (
                  <li class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-accent-secondary"></span>
                    <span>{post.title}</span>
                    <span class="text-text-muted text-sm">/{post.slug}</span>
                  </li>
                ))}
              </ul>
            ) : (
              <p class="text-text-muted">Aucun article trouvé.</p>
            )}
          </Card>
        </>
      )}

      <!-- Debug Info -->
      <Card hover={false}>
        <h2 class="text-xl font-semibold mb-4">Debug</h2>
        <pre class="text-xs text-text-muted bg-bg-tertiary p-4 rounded-lg overflow-auto max-h-64">
{JSON.stringify({ wpAvailable, data, error }, null, 2)}
        </pre>
      </Card>

      <div class="mt-8">
        <a href="/" class="text-accent-primary hover:underline">&larr; Retour à l'accueil</a>
      </div>
    </Container>
  </section>
</BaseLayout>
