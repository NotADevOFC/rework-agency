---
// Server-side rendering for dynamic WordPress content
export const prerender = false;

import BaseLayout from '../../layouts/BaseLayout.astro';
import Container from '../../components/ui/Container.astro';
import Button from '../../components/ui/Button.astro';
import { fetchGraphQL, isWordPressAvailable } from '../../lib/wordpress';
import { GET_PROJECT_BY_SLUG } from '../../lib/queries/projects';
import type { ProjectResponse, Project } from '../../types';

// Helper to get technologies from project
function getTechnologies(project: Project): string[] {
  if (project.technologies?.nodes) {
    return project.technologies.nodes.map(t => t.name);
  }
  return [];
}

// Mock projects for static generation
const mockProjects: Record<string, Project> = {
  'ecommerce-mode': {
    id: '1',
    slug: 'ecommerce-mode',
    title: 'E-commerce Mode Premium',
    content: `
      <h2>Le défi</h2>
      <p>Maison Élégance, une marque de mode parisienne, souhaitait lancer sa boutique en ligne pour toucher une clientèle internationale tout en conservant l'expérience luxueuse de ses boutiques physiques.</p>

      <h2>Notre solution</h2>
      <p>Nous avons développé une boutique Shopify sur mesure avec un design épuré et élégant. L'accent a été mis sur la qualité des visuels produits et une navigation intuitive.</p>

      <h2>Fonctionnalités clés</h2>
      <ul>
        <li>Design responsive premium</li>
        <li>Galeries produits haute définition avec zoom</li>
        <li>Système de tailles intelligent</li>
        <li>Paiement multi-devises</li>
        <li>Livraison internationale intégrée</li>
      </ul>

      <h2>Résultats</h2>
      <p>+150% de ventes en ligne la première année, avec un taux de conversion de 3.2% (vs 1.8% moyenne du secteur).</p>
    `,
    featuredImage: undefined,
    technologies: { nodes: [{ name: 'Shopify', slug: 'shopify' }, { name: 'Liquid', slug: 'liquid' }, { name: 'JavaScript', slug: 'javascript' }, { name: 'SCSS', slug: 'scss' }] },
    projectFields: {
      client: 'Maison Élégance',
      year: '2024',
      liveUrl: 'https://exemple.com',
    },
  },
  'saas-dashboard': {
    id: '2',
    slug: 'saas-dashboard',
    title: 'Dashboard SaaS Analytics',
    content: `
      <h2>Le défi</h2>
      <p>DataFlow, une startup tech, avait besoin d'une plateforme permettant à ses clients de visualiser et analyser leurs données en temps réel de manière intuitive.</p>

      <h2>Notre solution</h2>
      <p>Développement d'une application React avec des visualisations D3.js interactives et un backend Node.js performant pour le traitement des données.</p>

      <h2>Fonctionnalités clés</h2>
      <ul>
        <li>Tableaux de bord personnalisables</li>
        <li>Graphiques interactifs en temps réel</li>
        <li>Export de rapports PDF/Excel</li>
        <li>Système d'alertes configurables</li>
        <li>API REST documentée</li>
      </ul>

      <h2>Résultats</h2>
      <p>Adoption par +200 entreprises dans les 6 premiers mois avec un NPS de 72.</p>
    `,
    featuredImage: undefined,
    technologies: { nodes: [{ name: 'React', slug: 'react' }, { name: 'TypeScript', slug: 'typescript' }, { name: 'D3.js', slug: 'd3js' }, { name: 'Node.js', slug: 'nodejs' }, { name: 'PostgreSQL', slug: 'postgresql' }] },
    projectFields: {
      client: 'DataFlow',
      year: '2024',
      liveUrl: 'https://exemple.com',
    },
  },
  'site-vitrine-architecte': {
    id: '3',
    slug: 'site-vitrine-architecte',
    title: 'Portfolio Architecte',
    content: `
      <h2>Le défi</h2>
      <p>Studio Archi cherchait un site portfolio qui mette en valeur leurs projets architecturaux avec une esthétique minimaliste reflétant leur philosophie de design.</p>

      <h2>Notre solution</h2>
      <p>Un site Astro ultra-performant avec des galeries immersives et des animations subtiles au scroll pour une expérience de navigation mémorable.</p>

      <h2>Fonctionnalités clés</h2>
      <ul>
        <li>Galeries plein écran avec transitions fluides</li>
        <li>Animations GSAP au scroll</li>
        <li>Score Lighthouse 100/100</li>
        <li>Filtrage par type de projet</li>
        <li>Formulaire de contact intégré</li>
      </ul>

      <h2>Résultats</h2>
      <p>+80% de demandes de devis via le site et mention dans plusieurs blogs d'architecture.</p>
    `,
    featuredImage: undefined,
    technologies: { nodes: [{ name: 'Astro', slug: 'astro' }, { name: 'Tailwind CSS', slug: 'tailwind-css' }, { name: 'GSAP', slug: 'gsap' }, { name: 'TypeScript', slug: 'typescript' }] },
    projectFields: {
      client: 'Studio Archi',
      year: '2023',
      liveUrl: 'https://exemple.com',
    },
  },
};

const { slug } = Astro.params;

let project: Project | null = null;
let isFromWordPress = false;

try {
  const wpAvailable = await isWordPressAvailable();
  if (wpAvailable) {
    const data = await fetchGraphQL<ProjectResponse>(GET_PROJECT_BY_SLUG, { slug });
    if (data.project) {
      project = data.project;
      isFromWordPress = true;
    }
  }
} catch (error) {
  console.error('Error fetching project:', error);
}

// Use mock data if no WordPress data
if (!project && slug && mockProjects[slug]) {
  project = mockProjects[slug];
}

if (!project) {
  return Astro.redirect('/projets');
}

const technologies = getTechnologies(project);

// Mock results for display
const projectResults = [
  { value: '+150%', label: 'Ventes en ligne' },
  { value: '3.2%', label: 'Taux de conversion' },
  { value: '100', label: 'Score Lighthouse' },
];
---

<BaseLayout
  title={project.title}
  description={project.excerpt || `Découvrez notre réalisation : ${project.title}`}
>
  <!-- Hero Section -->
  <section class="relative pt-32 pb-20 overflow-hidden">
    <!-- Background -->
    <div class="absolute inset-0 grid-bg opacity-30"></div>
    <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-gradient-to-bl from-accent-primary/20 via-accent-secondary/10 to-transparent rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-gradient-to-tr from-accent-secondary/15 to-transparent rounded-full blur-3xl"></div>

    <Container class="relative z-10">
      <!-- Back Link -->
      <a
        href="/projets"
        class="inline-flex items-center gap-2 text-text-muted hover:text-white transition-colors mb-8 group reveal"
      >
        <svg class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span>Retour aux projets</span>
      </a>

      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <!-- Left Column - Info -->
        <div>
          <!-- Client Badge -->
          <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-accent-primary/20 to-accent-secondary/20 border border-accent-primary/30 mb-6 reveal">
            <span class="w-2 h-2 rounded-full bg-accent-primary"></span>
            <span class="text-sm font-medium text-accent-primary">{project.projectFields.client}</span>
          </div>

          <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold tracking-tight mb-6 reveal">
            {project.title}
          </h1>

          {project.excerpt && (
            <p class="text-xl text-text-secondary mb-8 reveal" set:html={project.excerpt} />
          )}

          <!-- Meta Info -->
          <div class="flex flex-wrap gap-6 mb-8 reveal">
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span class="text-text-secondary">{project.projectFields.year}</span>
            </div>
            {project.projectFields.liveUrl && (
              <a
                href={project.projectFields.liveUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 text-accent-primary hover:underline"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
                <span>Voir le site</span>
              </a>
            )}
          </div>

          <!-- Technologies -->
          <div class="reveal">
            <h3 class="text-sm text-text-muted uppercase tracking-wider mb-3">Technologies</h3>
            <div class="flex flex-wrap gap-2">
              {technologies.map((tech) => (
                <span class="px-4 py-2 rounded-full bg-white/5 border border-white/10 text-sm text-text-secondary hover:border-accent-primary/50 hover:text-white transition-all">
                  {tech}
                </span>
              ))}
            </div>
          </div>
        </div>

        <!-- Right Column - Image -->
        <div class="reveal">
          <div class="relative rounded-2xl overflow-hidden border border-white/10 shadow-2xl shadow-black/50">
            <div class="absolute inset-0 bg-gradient-to-br from-accent-primary/10 to-accent-secondary/10"></div>
            {project.featuredImage?.node ? (
              <img
                src={project.featuredImage.node.sourceUrl}
                alt={project.featuredImage.node.altText || project.title}
                class="w-full aspect-video object-cover relative z-10"
              />
            ) : (
              <div class="w-full aspect-video bg-gradient-to-br from-bg-tertiary to-bg-secondary flex items-center justify-center relative z-10">
                <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-accent-primary/20 to-accent-secondary/20 flex items-center justify-center">
                  <svg class="w-12 h-12 text-accent-primary/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </Container>
  </section>

  <!-- Content Section -->
  <section class="py-20 relative">
    <Container>
      <div class="grid lg:grid-cols-3 gap-12">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          {project.content && (
            <div
              class="prose prose-invert prose-lg max-w-none reveal
                     prose-headings:font-bold prose-headings:text-text-primary
                     prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:bg-gradient-to-r prose-h2:from-accent-primary prose-h2:to-accent-secondary prose-h2:bg-clip-text prose-h2:text-transparent
                     prose-p:text-text-secondary prose-p:leading-relaxed prose-p:mb-6
                     prose-li:text-text-secondary prose-li:marker:text-accent-primary
                     prose-ul:my-6 prose-ul:space-y-3
                     prose-a:text-accent-primary prose-a:no-underline hover:prose-a:underline
                     prose-strong:text-text-primary prose-strong:font-semibold"
              set:html={project.content}
            />
          )}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
          <!-- Project Info Card -->
          <div class="p-6 rounded-2xl bg-white/5 border border-white/10 backdrop-blur-sm reveal">
            <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
              <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              Informations
            </h3>
            <dl class="space-y-5">
              <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent-primary/20 to-accent-secondary/20 flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                  </svg>
                </div>
                <div>
                  <dt class="text-text-muted text-sm">Client</dt>
                  <dd class="font-medium text-white">{project.projectFields.client}</dd>
                </div>
              </div>
              <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent-primary/20 to-accent-secondary/20 flex items-center justify-center flex-shrink-0">
                  <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
                <div>
                  <dt class="text-text-muted text-sm">Année</dt>
                  <dd class="font-medium text-white">{project.projectFields.year}</dd>
                </div>
              </div>
              {project.projectFields.liveUrl && (
                <div class="flex items-start gap-4">
                  <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent-primary/20 to-accent-secondary/20 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                    </svg>
                  </div>
                  <div>
                    <dt class="text-text-muted text-sm">Site web</dt>
                    <dd>
                      <a
                        href={project.projectFields.liveUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-accent-primary hover:underline inline-flex items-center gap-1"
                      >
                        Visiter
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                      </a>
                    </dd>
                  </div>
                </div>
              )}
            </dl>
          </div>

          <!-- Results Card -->
          <div class="p-6 rounded-2xl bg-gradient-to-br from-accent-primary/10 to-accent-secondary/10 border border-accent-primary/20 reveal">
            <h3 class="font-semibold text-lg mb-6 flex items-center gap-2">
              <svg class="w-5 h-5 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
              </svg>
              Résultats
            </h3>
            <div class="space-y-4">
              {projectResults.map((result) => (
                <div class="flex items-center justify-between">
                  <span class="text-text-secondary text-sm">{result.label}</span>
                  <span class="font-bold text-xl bg-gradient-to-r from-accent-primary to-accent-secondary bg-clip-text text-transparent">
                    {result.value}
                  </span>
                </div>
              ))}
            </div>
          </div>

          <!-- CTA Card -->
          <div class="p-6 rounded-2xl bg-white/5 border border-white/10 text-center reveal">
            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-accent-primary/20 to-accent-secondary/20 flex items-center justify-center">
              <svg class="w-8 h-8 text-accent-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <h3 class="font-semibold mb-2">Un projet similaire ?</h3>
            <p class="text-text-secondary text-sm mb-4">
              Discutons de votre projet et voyons comment nous pouvons vous aider.
            </p>
            <Button href="/contact" size="sm" class="w-full">
              Nous contacter
            </Button>
          </div>
        </div>
      </div>
    </Container>
  </section>

  <!-- Navigation Section -->
  <section class="py-20 border-t border-white/10">
    <Container>
      <div class="flex flex-col sm:flex-row justify-between items-center gap-6 reveal">
        <a
          href="/projets"
          class="group flex items-center gap-3 px-6 py-3 rounded-xl bg-white/5 border border-white/10 hover:border-accent-primary/50 transition-all"
        >
          <svg class="w-5 h-5 text-text-muted group-hover:text-accent-primary transition-colors transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="text-text-secondary group-hover:text-white transition-colors">Tous les projets</span>
        </a>

        <Button href="/contact" size="lg" class="group">
          <span>Démarrer votre projet</span>
          <svg class="w-5 h-5 ml-2 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </Button>
      </div>
    </Container>
  </section>
</BaseLayout>

<style>
  .reveal {
    opacity: 0;
    transform: translateY(20px);
  }

  .reveal.visible {
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.6s ease, transform 0.6s ease;
  }
</style>

<script>
  // Reveal animations
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
      }
    });
  }, observerOptions);

  document.querySelectorAll('.reveal').forEach(el => {
    observer.observe(el);
  });
</script>
